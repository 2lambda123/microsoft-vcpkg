diff --git a/glib/glib-init.c b/glib/glib-init.c
index 30a9654..31723d7 100644
--- a/glib/glib-init.c
+++ b/glib/glib-init.c
@@ -275,12 +275,14 @@ glib_init (void)
 
 #if defined (G_OS_WIN32)
 
+HMODULE glib_dll;
+
+#if defined (DLL_EXPORT)
+
 BOOL WINAPI DllMain (HINSTANCE hinstDLL,
                      DWORD     fdwReason,
                      LPVOID    lpvReserved);
 
-HMODULE glib_dll;
-
 BOOL WINAPI
 DllMain (HINSTANCE hinstDLL,
          DWORD     fdwReason,
@@ -317,6 +319,7 @@ DllMain (HINSTANCE hinstDLL,
 
   return TRUE;
 }
+#endif
 
 #elif defined (G_HAS_CONSTRUCTORS)
 
diff --git a/glib/gutils.h b/glib/gutils.h
index f84fbcb..94c893e 100644
--- a/glib/gutils.h
+++ b/glib/gutils.h
@@ -330,7 +330,7 @@ void g_abort (void) G_GNUC_NORETURN G_ANALYZER_NORETURN;
 
 #ifndef G_PLATFORM_WIN32
 # define G_WIN32_DLLMAIN_FOR_DLL_NAME(static, dll_name)
-#else
+#elif defined (DLL_EXPORT)
 # define G_WIN32_DLLMAIN_FOR_DLL_NAME(static, dll_name)			\
 static char *dll_name;							\
 									\
diff --git a/gobject/gtype.c b/gobject/gtype.c
index f381a78..95b6dbd 100644
--- a/gobject/gtype.c
+++ b/gobject/gtype.c
@@ -4451,7 +4451,7 @@ gobject_init (void)
   _g_signal_init ();
 }
 
-#if defined (G_OS_WIN32)
+#if defined (G_OS_WIN32) && defined (DLL_EXPORT)
 
 BOOL WINAPI DllMain (HINSTANCE hinstDLL,
                      DWORD     fdwReason,
