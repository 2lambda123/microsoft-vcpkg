From 2ab39817f6bb2416f64e1f63d38fed9732ae676b Mon Sep 17 00:00:00 2001
From: quqiOnfree <quqiOnfree@outlook.com>
Date: Sun, 16 Jun 2024 10:57:26 +0800
Subject: [PATCH] use vcpkg

---
 .gitignore                |  13 ++
 CMakeLists.txt            | 294 +++++---------------------------------
 mariadbcppConfig.cmake.in |   4 +
 3 files changed, 56 insertions(+), 255 deletions(-)
 create mode 100644 mariadbcppConfig.cmake.in

diff --git a/.gitignore b/.gitignore
index 3fee95a..6a87ed4 100644
--- a/.gitignore
+++ b/.gitignore
@@ -72,3 +72,16 @@ benchmark/main-benchmark
 *.exe
 *.out
 *.app
+
+# Build directories
+build/
+out/
+
+# Visual Studio directory
+.vs/
+.vscode/
+
+# Other build files
+install_test/CMakeLists.txt
+src/maconncpp.def
+src/Version.h
\ No newline at end of file
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 43bc4a2..93d705d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -407,30 +407,6 @@ IF (WITH_MSAN)
   MY_CHECK_AND_SET_COMPILER_FLAG("-fsanitize=memory -fsanitize-memory-track-origins -U_FORTIFY_SOURCE" DEBUG RELWITHDEBINFO)
 ENDIF()
 
-# This has to be before C/C's cmake run, or it will build with /MD
-IF(WIN32)
-  IF (MSVC)
-    SET(CONFIG_TYPES "DEBUG" "RELEASE" "RELWITHDEBINFO" "MINSIZEREL")
-    FOREACH(BUILD_TYPE ${CONFIG_TYPES})
-      FOREACH(COMPILER ${MAODBC_LANGUAGES})
-        SET(COMPILER_FLAGS "${CMAKE_${COMPILER}_FLAGS_${BUILD_TYPE}}")
-        IF (NOT COMPILER_FLAGS STREQUAL "")
-          IF(NOT WITH_ASAN)
-            STRING(REPLACE "/MD" "/MT" COMPILER_FLAGS ${COMPILER_FLAGS})
-            STRING(REPLACE "/Zi" "/ZI" COMPILER_FLAGS ${COMPILER_FLAGS})
-          ENDIF(NOT WITH_ASAN)
-          MESSAGE (STATUS "CMAKE_${COMPILER}_FLAGS_${BUILD_TYPE}= ${COMPILER_FLAGS}")
-          SET(CMAKE_${COMPILER}_FLAGS_${BUILD_TYPE} ${COMPILER_FLAGS} CACHE
-               STRING "Overwritten by mariadb-cpp" FORCE)
-        ENDIF()
-      ENDFOREACH()
-    ENDFOREACH()
-  ENDIF()
-  ADD_DEFINITIONS(-D_CRT_SECURE_NO_WARNINGS -D_SCL_SECURE_NO_WARNINGS -DWIN32_LEAN_AND_MEAN)
-  SET(INSTALL_PLUGINDIR "${MARIADB_DEFAULT_PLUGINS_SUBDIR}")
-  SET(PLATFORM_DEPENDENCIES ${PLATFORM_DEPENDENCIES} version.lib)
-ENDIF()
-
 ### Build options, initial settings and platform defaults
 INCLUDE("options_defaults")
 
@@ -469,148 +445,21 @@ IF(NOT WITH_SSL)
 ENDIF()
 
 ### Including C/C subproject
-IF(NOT USE_SYSTEM_INSTALLED_LIB)
-  IF(EXISTS ${CMAKE_SOURCE_DIR}/libmariadb)
-    IF(GIT_BUILD_SRCPKG)
-      # We don't want conn/c (wrong) src pkg to be built.
-      SET(GIT_BUILD_SRCPKG FALSE)
-      SET(CONNCPP_GIT_BUILD_SRCPKG TRUE)
-    ENDIF()
-    MESSAGE(STATUS "Running C/C cmake scripts")
-    INCLUDE(connector_c)
-    INSTALL(FILES $<TARGET_FILE:libmariadb>
-            DESTINATION ${INSTALL_LIBDIR}
- 	          COMPONENT ConnectorC)
-    MESSAGE(STATUS "Configuring to install libmariadb to ${INSTALL_LIBDIR}")
-
-    SET(OWN_PLUGINS_LIST mysql_clear_password dialog client_ed25519 sha256_password caching_sha2_password)
-    IF (PLUGINS_DYNAMIC)
-      # The list from CC is visible for us
-      SET(PLUGINS_LIST ${PLUGINS_DYNAMIC})
-    ELSE()
-      SET(PLUGINS_LIST ${OWN_PLUGINS_LIST})
-    ENDIF()
-    # Why is it here?
-    IF(APPLE)
-      SET(PRODUCT_IDENTIFIER "com.mariadb.connector.cpp")
-      SET_TARGET_PROPERTIES(${PLUGINS_LIST}
-                            PROPERTIES XCODE_ATTRIBUTE_ENABLE_HARDENED_RUNTIME YES
-                                       XCODE_ATTRIBUTE_OTHER_CODE_SIGN_FLAGS "--timestamp -f"
-                           )
-      IF(WITH_SIGNCODE)
-        SET_TARGET_PROPERTIES(${PLUGINS_LIST} PROPERTIES XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY "Developer ID Application: ${DEVELOPER_ID}")
-      ELSE()
-        SET_TARGET_PROPERTIES(${PLUGINS_LIST} PROPERTIES XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY "")
-      ENDIF()
-    ENDIF()
-
-    FOREACH(CC_PLUGIN ${PLUGINS_LIST})
-      IF(NOT PLUGINS_DYNAMIC OR "${PLUGIN_${CC_PLUGIN}_TYPE}" STREQUAL "MARIADB_CLIENT_PLUGIN_AUTH")
-        MESSAGE(STATUS "Configuring to install ${CC_PLUGIN} to ${INSTALL_PLUGINDIR}")
-        ADD_DEPENDENCIES(DEPENDENCIES_FOR_PACKAGE ${CC_PLUGIN})
-        INSTALL(FILES $<TARGET_FILE:${CC_PLUGIN}>
-                DESTINATION ${INSTALL_PLUGINDIR}
-                COMPONENT Plugins)
-      ENDIF()
-    ENDFOREACH()
-    INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/libmariadb/include)
-    INCLUDE_DIRECTORIES(${CMAKE_BINARY_DIR}/libmariadb/include)
-  ELSE()
-    SET(USE_SYSTEM_INSTALLED_LIB TRUE)
-    IF (NOT WIN32)
-      INCLUDE_DIRECTORIES(/usr/include/mariadb)
-      # /usr/${INSTALL_LIBDIR}
-    ENDIF()
-    MESSAGE(STATUS "There is no Connector/C sub-project folder, linking against libmariadb installed on the system")
-  ENDIF()
-ENDIF()
-
-IF(WITH_MSI AND WITH_SIGNCODE)
-  IF(WIN32 AND NOT SIGN_OPTIONS)
-    SET(SIGN_OPTIONS /a /t http://timestamp.verisign.com/scripts/timstamp.dll)
-  ELSE()
-    SEPARATE_ARGUMENTS(SIGN_OPTIONS)
-  ENDIF()
-  MARK_AS_ADVANCED(SIGN_OPTIONS)
-ENDIF()
-
-INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/include)
-INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/include/conncpp)
-INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/src)
-INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/class)
-IF(NOT CMAKE_BUILD_TYPE)
-  SET(CMAKE_BUILD_TYPE "RelWithDebInfo")
-ENDIF()
-CONFIGURE_FILE(${CMAKE_SOURCE_DIR}/src/maconncpp.def.in
-               ${CMAKE_SOURCE_DIR}/src/maconncpp.def)
-
-# Dynamic linking is default on non-Windows
-IF(MARIADB_LINK_DYNAMIC)
-  IF(USE_SYSTEM_INSTALLED_LIB)
-    IF(MINGW)
-      # I guess -l can be removed here. Also, for build with c/c as submodule this will have to me moved on top level out of this IF's 
-      SET(PLATFORM_DEPENDENCIES "${PLATFORM_DEPENDENCIES}" "-lsecur32 -lcrypt32")
-      # Not sure if mingw really needs this separate mysql.h search, but let it be
-      FIND_PATH(MARIADB_CONNECTORC_INCLUDE NAMES "mysql.h"
-                DOC "Path to MariaDB Connector/C Include Directory")
-
-      FIND_PATH(MARIADB_CONNECTORC_LIB NAMES libmariadbclient.a
-                                             liblibmariadb.dll.a 
-                                             libmariadb.dll 
-                                             mariadbclient
-                                             mariadb
-                DOC "Path to MariaDB Connector/C Lib Directory")
-      # Not sure why is shlwapi is needed
-      FIND_LIBRARY(MARIADB_SHLWAPI_LIB NAMES ShLwApi.Lib 
-                                             ShLwApi
-                DOC "Path to ShLwApi.Lib. Usually found in $ENV{programfiles\(x86\)}\\Windows Kits\\10\\Lib")
-    ELSE()
-      FIND_LIBRARY(CCLIB libmariadb.so)
-      IF (${CCLIB} STREQUAL "CCLIB-NOTFOUND")
-        # It won't be found by linker either unless user does some magic before build, so we actually could stop here with error
-        MESSAGE(STATUS "C/C library has not been found")
-        SET(MARIADB_CLIENT_TARGET_NAME mariadb)
-      ELSE()
-        MESSAGE(STATUS "C/C library found here ${CCLIB}")
-        SET(MARIADB_CLIENT_TARGET_NAME ${CCLIB})
-      ENDIF()
-      FIND_FILE(CCHEADER NAMES "mysql.h"
-                PATHS /usr/include/mariadb
-                      /usr/include/mysql
-                      /usr/local/include/mariadb
-                      /usr/local/include/mysql)
-                #PATH_SUFFIXES mariadb mysql)
-      IF (${CCHEADER} STREQUAL "CCHEADER-NOTFOUND")
-        # Again should probably stop
-        MESSAGE(STATUS "C/C headers have not been found")
-        INCLUDE_DIRECTORIES(/usr/include/mariadb /usr/include/mysql)
-      ELSE()
-        GET_FILENAME_COMPONENT(CCHEADERDIR ${CCHEADER} DIRECTORY)
-        MESSAGE(STATUS "C/C headers have been found here ${CCHEADERDIR}")
-        INCLUDE_DIRECTORIES(${CCHEADERDIR})
-      ENDIF()
-    ENDIF()
-  ELSE()
-    SET(MARIADB_CLIENT_TARGET_NAME libmariadb)
-  ENDIF()
-  MESSAGE(STATUS "Linking Connector/C library dynamically(${MARIADB_CLIENT_TARGET_NAME})")
-ELSE()
-  SET(MARIADB_CLIENT_TARGET_NAME mariadbclient)
-  MESSAGE(STATUS "Linking Connector/C library statically(${MARIADB_CLIENT_TARGET_NAME})")
-ENDIF()
-
-
-ADD_LIBRARY(${LIBRARY_NAME}_obj OBJECT ${MACPP_SOURCES})
-IF(UNIX)
-  SET_TARGET_PROPERTIES(${LIBRARY_NAME}_obj PROPERTIES COMPILE_FLAGS "${CMAKE_SHARED_LIBRARY_C_FLAGS}")
-ENDIF()
-SET(${LIBRARY_NAME}_OBJECTS $<TARGET_OBJECTS:${LIBRARY_NAME}_obj>)
+FIND_PACKAGE(unofficial-libmariadb CONFIG REQUIRED)
+INCLUDE_DIRECTORIES(${LIBRARY_NAME}
+    include/conncpp
+    include
+    src
+    class)
+INCLUDE_DIRECTORIES(${STATIC_LIBRARY_NAME}
+    include/conncpp
+    include
+    src
+    class)
 
 IF(WIN32 AND NOT MINGW)
-  ADD_LIBRARY(${LIBRARY_NAME} SHARED ${CMAKE_SOURCE_DIR}/src/maconncpp.rc ${${LIBRARY_NAME}_OBJECTS} ${CMAKE_SOURCE_DIR}/src/maconncpp.def)
-  ADD_LIBRARY(${STATIC_LIBRARY_NAME} STATIC ${${LIBRARY_NAME}_OBJECTS} ${CMAKE_SOURCE_DIR}/src/maconncpp.rc)
-
-  TARGET_COMPILE_DEFINITIONS(${LIBRARY_NAME}_obj PRIVATE "MARIADB_EXPORTED=__declspec(dllexport)")
+  ADD_LIBRARY(${LIBRARY_NAME} SHARED ${CMAKE_SOURCE_DIR}/src/maconncpp.rc ${MACPP_SOURCES} ${CMAKE_SOURCE_DIR}/src/maconncpp.def)
+  ADD_LIBRARY(${STATIC_LIBRARY_NAME} STATIC ${MACPP_SOURCES} ${CMAKE_SOURCE_DIR}/src/maconncpp.rc)
 
   TARGET_COMPILE_DEFINITIONS(${LIBRARY_NAME} PRIVATE "MARIADB_EXPORTED=__declspec(dllexport)")
   TARGET_COMPILE_DEFINITIONS(${LIBRARY_NAME} INTERFACE "MARIADB_EXPORTED=__declspec(dllimport)")
@@ -624,8 +473,8 @@ ELSE()
     SET(EMPTY_FILE ${CMAKE_BINARY_DIR}/empty.cpp)
   ENDIF()
   #  MESSAGE(STATUS "Version script: ${CMAKE_SOURCE_DIR}/src/maconncpp.def")
-  ADD_LIBRARY(${LIBRARY_NAME} SHARED ${${LIBRARY_NAME}_OBJECTS} ${EMPTY_FILE})
-  ADD_LIBRARY(${STATIC_LIBRARY_NAME} STATIC ${${LIBRARY_NAME}_OBJECTS} ${EMPTY_FILE})
+  ADD_LIBRARY(${LIBRARY_NAME} SHARED ${MACPP_SOURCES} ${EMPTY_FILE})
+  ADD_LIBRARY(${STATIC_LIBRARY_NAME} STATIC ${MACPP_SOURCES} ${EMPTY_FILE})
 
   IF(APPLE)
     SET_TARGET_PROPERTIES(${LIBRARY_NAME} PROPERTIES LINK_FLAGS "-Wl"
@@ -652,102 +501,37 @@ ELSE()
   ENDIF()
 ENDIF()
 
-TARGET_LINK_LIBRARIES(${LIBRARY_NAME} ${MARIADB_CLIENT_TARGET_NAME} ${PLATFORM_DEPENDENCIES})
-TARGET_LINK_LIBRARIES(${STATIC_LIBRARY_NAME} mariadbclient)
+TARGET_LINK_LIBRARIES(${LIBRARY_NAME} ${MARIADB_CLIENT_TARGET_NAME} ${PLATFORM_DEPENDENCIES} unofficial::libmariadb)
+TARGET_LINK_LIBRARIES(${STATIC_LIBRARY_NAME} mariadbclient unofficial::libmariadb)
 
-# MINGW Specific includes and linking
-IF(MINGW)
-  
-  IF(MARIADB_SHLWAPI_LIB)
-    TARGET_LINK_LIBRARIES(${LIBRARY_NAME} ${MARIADB_SHLWAPI_LIB})
-    MESSAGE(STATUS "Found shlwapi lib - ${MARIADB_SHLWAPI_LIB}")
-  ELSE()
-    # Should here and below be just warnings?
-    MESSAGE(WARNING "Did not find shlwapi lib")
-  ENDIF()
+# install
 
-  IF(MARIADB_CONNECTORC_INCLUDE)
-    # Probably has to be private, and not PUBLIC here
-    TARGET_INCLUDE_DIRECTORIES(${LIBRARY_NAME}_obj PUBLIC  ${MARIADB_CONNECTORC_INCLUDE})
-    MESSAGE(STATUS "Found MariaDB Connector/C includes - ${MARIADB_CONNECTORC_INCLUDE}")
-  ELSE()
-    MESSAGE(WARNING "Did not find MariaDB Connector/C includes")
-  ENDIF()
-  
-  IF(MARIADB_CONNECTORC_LIB)
-    TARGET_LINK_DIRECTORIES(${LIBRARY_NAME} PUBLIC ${MARIADB_CONNECTORC_LIB})
-    TARGET_LINK_DIRECTORIES(${STATIC_LIBRARY_NAME} PUBLIC ${MARIADB_CONNECTORC_LIB})
-    MESSAGE(STATUS "Found MariaDB Connector/C libraries - ${MARIADB_CONNECTORC_LIB}")
-  ELSE()
-    MESSAGE(WARNING "Did not find MariaDB Connector/C libraries")
-  ENDIF()
-  
-ENDIF()
+install(TARGETS ${LIBRARY_NAME} ${STATIC_LIBRARY_NAME}
+        EXPORT ${LIBRARY_NAME}Targets 
+        LIBRARY DESTINATION lib
+        ARCHIVE DESTINATION lib
+        RUNTIME DESTINATION bin
+        )
 
-INCLUDE(symlink)
-CREATE_SYMLINK(lib${LIBRARY_NAME}${CMAKE_STATIC_LIBRARY_SUFFIX} ${STATIC_LIBRARY_NAME} ${INSTALL_LIBDIR})
+file(GLOB HEADERS "${CMAKE_SOURCE_DIR}/include/*.hpp")
+install(FILES ${HEADERS} DESTINATION include/mariadbcpp)
 
-ADD_DEPENDENCIES(${LIBRARY_NAME} DEPENDENCIES_FOR_PACKAGE)
+file(GLOB HEADERS "${CMAKE_SOURCE_DIR}/include/conncpp/*.hpp")
+install(FILES ${HEADERS} DESTINATION include/mariadbcpp/conncpp)
 
-########## Packaging ##########
+file(GLOB HEADERS "${CMAKE_SOURCE_DIR}/include/conncpp/compat/*.hpp")
+install(FILES ${HEADERS} DESTINATION include/mariadbcpp/conncpp/compat)
 
-# MSI
-IF(WIN32)
-  IF(WITH_MSI)
-    ADD_CUSTOM_COMMAND(TARGET ${LIBRARY_NAME} POST_BUILD
-      COMMAND ${CMAKE_COMMAND} ARGS -DDRIVER_LIB_DIR=$<TARGET_FILE_DIR:${LIBRARY_NAME}>
-                                    -DPLUGINS_LIB_DIR=$<TARGET_FILE_DIR:dialog>
-                                    -DPLUGINS_SUBDIR_NAME=${MARIADB_DEFAULT_PLUGINS_SUBDIR}
-                                    -DFILE_IN=${CMAKE_SOURCE_DIR}/wininstall/binaries_dir.xml.in
-                                    -DFILE_OUT=${CMAKE_SOURCE_DIR}/wininstall/binaries_dir.xml
-                                    -P ${CMAKE_SOURCE_DIR}/cmake/ConfigureFile.cmake
-                       )
-    ADD_SUBDIRECTORY(wininstall)
-  ENDIF()
-ELSE()
-  IF(APPLE)
-    #MESSAGE(STATUS "Configuring to generate PKG package")
-    #ADD_SUBDIRECTORY(osxinstall)
-  ENDIF()
-  INSTALL(TARGETS ${LIBRARY_NAME}
-          LIBRARY DESTINATION ${INSTALL_LIBDIR}
-          COMPONENT SharedLibraries)
-  INSTALL(TARGETS
-          ${STATIC_LIBRARY_NAME}
-          ARCHIVE DESTINATION ${INSTALL_LIBDIR}
-          COMPONENT Development)
-
-  MESSAGE(STATUS "Documentation installed to ${INSTALL_DOCDIR}")
-  MESSAGE(STATUS "License file installed to ${INSTALL_LICENSEDIR}")
-  MESSAGE(STATUS "Public API header files installed to ${INSTALL_INCLUDEDIR}")
-  INSTALL(FILES
-          ${CMAKE_SOURCE_DIR}/README
-          DESTINATION
-          "${INSTALL_DOCDIR}"
-          COMPONENT Documentation)
-  INSTALL(FILES
-          ${CMAKE_SOURCE_DIR}/COPYING
-          DESTINATION
-          "${INSTALL_LICENSEDIR}"
-          COMPONENT Documentation)
-  ADD_SUBDIRECTORY(include)
-ENDIF()
-# Tests. Checking if we have them. May be not the case if we are building from source package
-IF(WITH_UNIT_TESTS AND EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/test/CMakeLists.txt")
-  ADD_SUBDIRECTORY(test)
-  ADD_CUSTOM_COMMAND(TARGET ${LIBRARY_NAME} POST_BUILD
-	  COMMAND ${CMAKE_COMMAND} ARGS -E copy $<TARGET_FILE:${LIBRARY_NAME}> test)
-  IF(NOT MINGW AND NOT USE_SYSTEM_INSTALLED_LIB)
-    ADD_CUSTOM_COMMAND(TARGET ${LIBRARY_NAME} POST_BUILD
-	  COMMAND ${CMAKE_COMMAND} ARGS -E copy $<TARGET_FILE:libmariadb> test)
-  ENDIF()
-ENDIF()
+install(EXPORT ${LIBRARY_NAME}Targets
+        FILE ${LIBRARY_NAME}Targets.cmake
+        NAMESPACE unofficial::
+        DESTINATION share/${LIBRARY_NAME}
+        )
 
-# Packaging
-INCLUDE(packaging)
-MESSAGE(STATUS "License File: ${CPACK_RESOURCE_FILE_LICENSE}")
-MESSAGE(STATUS "ReadMe File: ${CPACK_PACKAGE_DESCRIPTION_FILE}")
-MESSAGE(STATUS "Source Package Filename: ${CPACK_SOURCE_PACKAGE_FILE_NAME}.${CPACK_SOURCE_GENERATOR}")
+configure_file(${LIBRARY_NAME}Config.cmake.in ${LIBRARY_NAME}Config.cmake @ONLY)
+install(FILES "${CMAKE_CURRENT_BINARY_DIR}/${LIBRARY_NAME}Config.cmake"
+        DESTINATION share/${LIBRARY_NAME}
+        )
 
 # install_test/CMakeLists.txt configuration should go after packaging.cmake but before include(CPack). Since CPack included in packaging cmake,
 # that configuration has been moved there. For the same reason there also moved the message with package name
diff --git a/mariadbcppConfig.cmake.in b/mariadbcppConfig.cmake.in
new file mode 100644
index 0000000..2a69b8b
--- /dev/null
+++ b/mariadbcppConfig.cmake.in
@@ -0,0 +1,4 @@
+﻿include(CMakeFindDependencyMacro)
+find_dependency(libmariadb CONFIG REQUIRED)
+
+include("${CMAKE_CURRENT_LIST_DIR}/mariadbcppTargets.cmake")
\ No newline at end of file
-- 
2.45.2.windows.1

