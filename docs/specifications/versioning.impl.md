# Versioning Implementation Details

## Table of contents

[Port versions database](#port-versions-database)  
[Git manipulation](#git-manipulation)  
[Versioned portfile provider](#versioned-portfile-provider)  
[Baseline provider](#baseline-provider)  
[Versioned dependency resolution](#versioned-dependency-resolution)  
[Lock files](#lock-files)  

## Port versions database
As part of our versioning solution, we will generate a database that lists all versions of a port that can be recovered from our repository's history. 

The form of this database is a top-level folder `port_versions` that contains a database file in JSON format, named `{port_name}.db.json`, for each port in the `ports/` folder. The database files will be placed in a tree structure that follows the convention:

```
%VCPKG_ROOT%/
  port_versions/
     {first_char_of_port_name}-/
       {port_name}.db.json
```

For example, the database file for `rapidjson` is found in `%VCPKG_ROOT%/port_versions/r-/rapidjson.db.json`.

The database files can be initially generated by running the `%VCPKG_ROOT%/scripts/generatePortVersionsDb.py` script on a clone of the vcpkg repository. 

### Contents of the database files
The following is an example of the output of the current database files generator (the final form of the database files is still being discussed and investigated in the RFC for Git registries PR #13590).

```json
{
    "port": "rapidjson",
    "$comment": "Trimmed versions array for brevity of example",
    "versions": [
        {
            "commit-id": "08c951fef9de63cde1c6b94245a63db826be2e32",
            "version-date": "2020-02-08",
            "port-version": "0"
        },
        {
            "commit_id": "726c11148105a97aef39bec024fdb7c140b1b154",
            "version-date": "2019-06-28",
            "port-version": "0"
        },
        {
            "commit-id": "ac2be759a49be5e04634843fef23f41bba95a9ed",
            "version-string": "d87b698-1",
            "port-version": "1"
        }
    ]
}
```

## Git manipulation
An important part of both versioning and registries is how to deal with Git repository manipulation. For the sake of abstraction a common API is proposed.

### `VcpkgPaths::checkout_commit_path(repository, commit, subpath) -> fs::Path`
Performs a `git checkout` of a subpath inside the repository at the specified commit. Useful for retrieving a port at a specific version given that its commit ID is known or to retrieve a port from a Git registry. It returns the path where the contents of the subpath have been checked out locally.

### `VcpkgPaths::checkout_object(repository, object) -> fs::Path`
Performs a `git checkout` of a Git tree object. Returns the local path where the files have been checked out. An `object` is a hash of a specific subpath in the Git repository, each time the contents of a folder inside a Git repository change a new hash is calculated and added to the repository history. In this manner is possible to restore the contents of a folder given its Git tree hash.

## Versioned portfile provider
A new type of portfile provider that accepts a port name and version information.

Unlike other portfile providers that use the `ports/` folder as their data store. This portfile provider queries the port versions database to know how to fetch ports at specific versions and also to retrieve a list of available versions of ports. 

The following interface is provided:

### `.get_port(port_name, version)`
Queries the port versions database to find the specific Git commit at which the requested version was added, if such a commit is found, the portfile provider will check the port at the specific commit and load the port contents in the provider.

Example: 

If given the parameters:
* Port name: `"opencv4"` 
* Version: `"4.1.1"` 
* Port version: `1`

The portfile provider will find and checkout port `opencv4` at commit `d85a40d478e683561578d1f63bb992f8805e16cc`; which was the commit that added that specific version. 

_The versioned portfile provider does not attempt any kind of version resolution, such a task is responsibility of the versioned dependency resolver. The version information that `get_port()` accepts must be complete enough to resolve directly to an available version (i.e.: must include epoch, version string, version scheme, and port version)._

### `.get_available_versions(port_name)`
Queries the database to find all available version of a port. This method should be called by the versioned dependency resolver in order find out suitable versions to resolve dependency constraints.


## Baseline provider

## Versioned dependency resolution

## Lock files
