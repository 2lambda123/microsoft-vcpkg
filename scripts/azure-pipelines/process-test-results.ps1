# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: MIT
#

<#
.SYNOPSIS
Process the raw xUnit result file from vcpkg tool for uploading to AZP.

.DESCRIPTION
process-test-result takes the path a xUnit file generated by `vcpkg ci` and
modifies it in-place for reporting port builds as tests in Azure pipelines.

.PARAMETER xunit
The path to the xUnit file.
#>
[CmdletBinding()]
Param(
    [Parameter(Mandatory = $true)]
    [string]$xunit
)

if (-not(Test-Path $xunit)) {
    write-error "No such file: $xunit"
}

# Fix invalid XML
(Get-Content -Path $xunit -Raw) `
    -replace ' method="(Skip|Fail|Pass)">', ' result="$1">' `
    -replace '</failure></message>', '</message></failure>' |
    Set-Content -Path $xunit

[xml]$xmlContents = Get-Content $xunit
$node = $xmlContents.SelectSingleNode('/assemblies/assembly[@run-date="1970-01-01"]')
while ($null -ne $node) {
    $node.ParentNode.RemoveChild($node) | Out-Null
    $node = $xmlContents.SelectSingleNode('/assemblies/assembly[@run-date="1970-01-01"]')
}
$xmlContents.save($xunit)
